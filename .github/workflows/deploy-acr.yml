name: Build and push to Azure Container Registry

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare build context (only src/)
        run: |
          # create a clean build context containing only the src/ folder contents
          rm -rf build-context
          mkdir -p build-context
          # copy src contents (preserves subfolders). Adjust if your Dockerfile expects a different layout.
          cp -a src/. build-context/

          # Ensure Dockerfile is present in the build context
          if [ ! -f build-context/Dockerfile ]; then
            if [ -f src/Dockerfile ]; then
              cp src/Dockerfile build-context/Dockerfile
            else
              echo "ERROR: Dockerfile not found in src/ or build-context" >&2
              exit 1
            fi
          fi

          # Create the .env file inside the build context from the secret.
          # Use printf to preserve newlines; do NOT print the secret to the workflow logs.
          printf '%s' "${{ secrets.ENV }}" > build-context/.env
        shell: bash

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push image to ACR
        uses: docker/build-push-action@v4
        with:
          context: ./build-context
          file: ./build-context/Dockerfile
          push: true
          tags: ${{ secrets.ACR_REGISTRY }}/techworkshop-l300:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Cleanup build context (remove .env)
        run: |
          # Attempt secure delete of .env then remove build-context
          if command -v shred >/dev/null 2>&1; then
            shred -u build-context/.env || true
          else
            rm -f build-context/.env || true
          fi
          rm -rf build-context
        shell: bash